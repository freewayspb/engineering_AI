# Прототип 2: Нормализация данных и работа с шаблонами

## Цель

Демонстрация способности системы нормализовать и структурировать данные из машиночитаемых документов, объединять их по проектам, применять шаблоны подразделений и автоматически формировать унифицированные Excel-отчеты с контролем версий.

## Основная реализация

- **Нормализация данных**: приведение разнородных данных к единым схемам с валидацией через JSON Schema
- **Объединение по проектам**: группировка и агрегация данных по проектным атрибутам (projectId, projectName, designStage, rdCipher)
- **Применение шаблонов**: использование утвержденных шаблонов ПТО и сметного отдела для формирования отчетов
- **Автоматическое формирование отчетов**: генерация унифицированных Excel-отчетов (1.1/1.2/1.3) с проверкой структуры и форматирования
- **Контроль версий**: ведение журнала изменений и возможность перезапуска пайплайна обработки

## Выходные артефакты

- **Унифицированные XLSX**: отчеты по шаблонам подразделений (1.1 Формирование сводной спецификации, 1.2 Унификация спецификации, 1.3 Бюджетирование проекта)
- **JSON с метаданными**: структурированные данные с проектной привязкой и валидацией
- **processing.log.json**: журнал обработки с детализацией операций и статусами
- **Отчеты валидации**: сводки проверок соответствия шаблонам и корректировок

---

## План реализации

### Этап 1: Анализ данных (2 дня)
- [ ] Изучение структуры документов заказчика
- [ ] Выявление паттернов в данных
- [ ] Определение полей для извлечения
- [ ] Анализ типов текстовых запросов

### Этап 2: Алгоритмы структурирования (4 дня)
- [ ] Парсинг таблиц из PDF
- [ ] Извлечение ключевых полей
- [ ] Группировка связанных данных
- [ ] Валидация извлеченных данных

### Этап 3: Обработка текстовых запросов (4 дня)
- [ ] Реализация NLP-модуля для понимания запросов
- [ ] Создание системы поиска по базе знаний
- [ ] Разработка алгоритмов формирования ответов
- [ ] Интеграция с обученной системой

### Этап 4: Форматы вывода (2 дня)
- [ ] Генерация JSON-схем
- [ ] Приоритетный экспорт в Excel (XLSX)
- [ ] Создание шаблонов данных
- [ ] Тестирование совместимости

### Этап 5: Интеграция (2 дня)
- [ ] Связка с OCR-модулем
- [ ] Интеграция с системой обучения
- [ ] Обработка ошибок
- [ ] Оптимизация производительности

---

## Критерии успеха

- **Валидность JSON Schema**: ≥ 0.95 для структурированных данных
- **Согласованность с шаблонами**: соответствие колонкам, форматам и стилям утвержденных шаблонов подразделений
- **Поддержка пакетной обработки**: обработка множественных документов с журналированием операций
- **Журналирование и перезапуск**: ведение processing.log.json с возможностью восстановления состояния пайплайна
- **ACL**: соблюдение разграничения доступа по ролям и проектным атрибутам (NFR-005, NFR-006, NFR-007)
- **Качество отчетов**: формирование Excel-отчетов, полностью соответствующих активным версиям шаблонов

---

## Технический стек

- **Парсинг**: pandas, openpyxl
- **NLP**: spaCy, NLTK, transformers
- **Валидация**: jsonschema, cerberus
- **Поиск**: Elasticsearch, FAISS
- **Excel**: openpyxl, xlsxwriter
- **Язык**: Python 3.11+
- **Контейнеризация**: Docker

---

## Алгоритмы

- **Извлечение таблиц**: Tabula-py, Camelot
- **Классификация полей**: Regex + ML
- **Группировка данных**: Clustering algorithms
- **Валидация**: Rule-based + ML models
- **Понимание запросов**: BERT, RoBERTa для NLP
- **Поиск по базе знаний**: Semantic search, vector similarity
- **Формирование ответов**: Template-based + generative models

---

## Риски

- Нестандартные форматы документов
- Сложность извлечения таблиц
- Низкое качество исходных данных
- Сложность понимания естественных запросов
- Неоднозначность пользовательских запросов
- Производительность NLP-моделей
- Качество формирования Excel отчетов

---

## Demo Script (без метрик)
1. Импорт структурированных данных из P1 (таблицы спецификаций, сметы, метаданные).
2. Нормализация смет в унифицированную модель Estimate (totals/units/RD‑cipher).
3. Конфигурация шаблонов XLSX для ПТО и Сметного отдела.
4. Генерация отчётов: выбор шаблона → структурирование → форматирование → экспорт XLSX.
5. Ответы на запросы: показ примеров UC‑02 с использованием нормализованных данных.
6. Просмотр логов валидаций (сводка проверок и корректировок).

## Acceptance Checklist (без метрик)
- [ ] Данные из P1 корректно импортированы (таблицы/сметы/метаданные).
- [ ] Сметы нормализованы: рассчитаны totals, проверены units, есть RD‑cipher.
- [ ] Отчёты XLSX формируются по шаблонам подразделений, структура и стили соблюдены.
- [ ] Запросы UC‑02 возвращают корректно структурированные данные из базы знаний.
- [ ] Логи валидаций доступны и воспроизводимы.

---

## Sample data pack (для демонстрации)
- Импорт из P1: JSON метаданных и таблиц (PDF/DWG), Estimate JSON (ARP/GSFX/XML/XLS), черновые XLS.
- Шаблоны XLSX подразделений: ПТО, Сметный отдел (эталонные файлы от заказчика).

Связанные UC: UC‑02, UC‑05, UC‑28..UC‑32, UC‑35.

---

## Трассировка требований

- **BR-005**: Нормализация данных - приведение разнородных данных к единым схемам с валидацией
- **BR-006**: Объединение по проектам - группировка данных по проектным атрибутам и формирование сводных отчетов
- **BR-007**: Применение шаблонов - использование утвержденных шаблонов подразделений для формирования отчетов
- **FR-LEARN-01/02/03**: Обучение системы - накопление знаний о структуре данных и шаблонах отчетов
- **FR-DAT-02**: Структурирование данных - выходные данные в JSON с метаданными и валидацией
- **FR-PROJECT-03**: Проектная работа - привязка всех данных к конкретным проектам
- **FR-LOG-01/02**: Журналирование - ведение processing.log.json с детализацией операций
- **NFR-001**: Производительность - обработка документов за разумное время
- **NFR-005, NFR-006, NFR-007**: Безопасность - соблюдение ACL и локальная работа без интернета
- **NFR-008, NFR-009**: Совместимость - поддержка форматов и архитектурные решения для интеграции
