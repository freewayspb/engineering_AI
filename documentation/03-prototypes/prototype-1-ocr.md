# Прототип 1: OCR и извлечение данных из машиночитаемых источников

## Цель

Демонстрация технической осуществимости извлечения данных из машиночитаемых источников с использованием OCR-технологий для сканов PDF, изображений штампов, чертежей DWG и смет в виде сканов. Прототип обеспечивает обучение системы на извлеченных данных для последующего ответа на текстовые запросы.

## Основная реализация

- **OCR-пайплайн**: предобработка изображений (deskew, denoise, binarize) для улучшения качества распознавания
- **Распознавание штампов**: извлечение реквизитов из главного штампа (title, cipher, sheetNumber, documentName, sheetFormat, designStage, organization, documentDate, revisionNumber) для PDF и DWG
- **Табличное содержимое**: автоматическое извлечение табличных структур спецификаций с валидацией данных
- **Обработка смет**: парсинг сметных документов ARP/GSFX/XML/XLS в унифицированную модель Estimate
- **Проектная привязка**: все извлеченные данные привязываются к конкретным проектам с метаданными

## Выходные артефакты

- **JSON по схемам**: структурированные данные с валидацией через JSON Schema
- **XLSX для подразделений**: отчеты для ПТО и сметного отдела по утвержденным шаблонам
- **Вспомогательные файлы**: fullText (извлеченный текст), tables (табличные данные), estimate (нормализованные сметы)
- **processing.log.json**: журнал обработки с метаданными и статусами
- **Метаданные документов**: проектная привязка, реквизиты штампа, качество распознавания

---

## План реализации

### Этап 1: Исследование технологий (2 дня)
- [ ] Анализ OCR-решений для локального развертывания
- [ ] Тестирование Tesseract, EasyOCR, PaddleOCR
- [ ] Оценка производительности на тестовых данных
- [ ] Исследование технологий обучения на документах

### Этап 2: Базовая реализация OCR (3 дня)
- [ ] Создание модуля OCR для PDF/изображений
- [ ] Интеграция с выбранной OCR-библиотекой
- [ ] Реализация предобработки изображений
- [ ] Добавление проектной привязки к метаданным

### Этап 3: Специализированные форматы (3 дня)
- [ ] Обработка DWG-файлов (извлечение текстовых слоев)
- [ ] Парсинг смет ARP/GSFX
- [ ] Обработка нормативных документов (ГОСТы, СНиПы)
- [ ] Создание унифицированного API

### Этап 4: Обучение системы (3 дня)
- [ ] Реализация механизма обучения на документах
- [ ] Создание базы знаний из извлеченных данных
- [ ] Валидация качества обучения
- [ ] Интеграция с системой ответов на запросы

### Этап 5: Тестирование (2 дня)
- [ ] Тестирование на образцах заказчика
- [ ] Измерение точности распознавания
- [ ] Тестирование качества обучения системы
- [ ] Документирование ограничений

---

## Критерии успеха

- **Качество распознавания**: CER/WER ≤ согласованных порогов для русского языка и технических терминов
- **Валидность JSON Schema**: ≥ 0.9 для структурированных данных
- **Время обработки**: ≤ 30 сек на документ (NFR-001)
- **Устойчивость к ошибкам**: корректная обработка исключений и граничных случаев (NFR-003, NFR-004)
- **Поддержка форматов**: PDF/JPG/PNG/DWG с базовой обработкой ARP/GSFX/XML/XLS (NFR-008)
- **Проектная привязка**: все документы привязаны к конкретным проектам с метаданными

---

## Технический стек

- **OCR**: Tesseract/EasyOCR
- **PDF**: PyMuPDF/PyPDF2
- **DWG**: ezdxf
- **Обучение**: spaCy, transformers, scikit-learn
- **База знаний**: SQLite/PostgreSQL
- **Язык**: Python 3.11+
- **Контейнеризация**: Docker

---

## Риски

- Низкое качество сканирования документов
- Сложность парсинга специализированных форматов
- Производительность на больших файлах
- Недостаток качественных данных для обучения системы
- Сложность обучения на разнородных документах
- Производительность больших моделей обучения

---

## Demo Script (без метрик)
1. Загрузка входных файлов: PDF (МЧ и СО), DWG, ARP, GSFX, XML, XLS, DOCX.
2. Автоопределение типа (mc_pdf/scan_pdf/dwg/arp/gsfx/xml/xls/docx).
3. Для PDF (СО): предобработка (deskew/denoise/binarization) и OCR.
4. Извлечение: текст + координаты; парсинг `titleBlock` (штамп) и запись `TitleBlockExtractionLog`.
5. Извлечение таблиц (спецификации) из PDF/DWG; базовый парсинг смет ARP/GSFX/XML/XLS.
6. Сохранение метаданных и структурированных данных; показ привязки к проекту.
7. Просмотр промежуточных JSON (metadata, titleBlock, tables) и экспорт примерного XLS.

## Acceptance Checklist (без метрик)
- [ ] Тип файла корректно определён для каждого входа.
- [ ] Для PDF (СО) применяется предобработка и OCR выполняется без падений.
- [ ] Поля штампа извлечены и сохранены в `titleBlock`; присутствует лог извлечения.
- [ ] Табличные данные спецификаций извлечены (PDF/DWG) в базовую структуру.
- [ ] Сметы ARP/GSFX/XML/XLS распарсены в унифицированную структуру (без полной нормализации).
- [ ] Все артефакты сохраняются локально; показана проектная привязка.

---

## Sample data pack (для демонстрации)
- `documentation/06-assets/input-documents/prototype-input-documents/1..pdf` (PDF МЧ)
- `documentation/06-assets/input-documents/prototype-input-documents/2..pdf` (PDF СО)
- `documentation/06-assets/input-documents/prototype-input-documents/3..dwg` (DWG)
- `documentation/06-assets/input-documents/prototype-input-documents/4.arp` (ARP)
- `documentation/06-assets/input-documents/prototype-input-documents/5.gsfx` (GSFX)
- `documentation/06-assets/input-documents/prototype-input-documents/6.xml` (XML)
- `documentation/06-assets/input-documents/prototype-input-documents/7..rtf` (RTF, при необходимости)
- `documentation/06-assets/input-documents/prototype-input-documents/8.xlsx` (XLSX)

Связанные UC: UC‑04, UC‑04a, UC‑04b, UC‑21..UC‑32.

---

## Трассировка требований

- **BR-004**: Обработка смет ARP/GSFX/XML/XLS - прототип обеспечивает базовый парсинг в унифицированную модель Estimate
- **BR-014**: Извлечение реквизитов из главного штампа - реализовано для PDF и DWG с полным набором полей штампа
- **BR-015**: Табличное содержание спецификаций - автоматическое извлечение табличных структур с валидацией данных
- **FR-LEARN-01/02**: Обучение системы на документах - извлеченные данные используются для обучения интеллектуальной системы
- **FR-DAT-02**: Структурирование данных - выходные данные в JSON по схемам с валидацией
- **FR-LOG-01/02**: Журналирование обработки - ведение processing.log.json с метаданными и статусами
- **NFR-001**: Производительность - обработка ≤ 30 сек на документ
- **NFR-003, NFR-004**: Надежность - устойчивость к ошибкам и корректная обработка исключений
- **NFR-008**: Совместимость - поддержка основных форматов документов
