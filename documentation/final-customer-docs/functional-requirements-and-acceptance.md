# Функциональные требования, сценарии и метрики приёмки

**Версия**: 0.1 (черновик для заказчика)  
**Дата**: 2025-XX-XX  
**Назначение**: Самодостаточное описание функций прототипа, пользовательских сценариев и метрик приёмки без ссылок на другие папки.

---

## 1. Запросы и ответы
Описание: система принимает текстовые запросы на русском, учитывает проектный контекст и формирует структурированные ответы (Excel/JSON/CSV) с указанием источников.
- Требования:
  - Принимает запросы с projectId и фильтрами; поддерживает list/detail/aggregate.
  - Формирует ответы с items/aggregates и trace на исходные документы.
  - Время ответа ≤ 30 секунд.
- Комментарии:
  - Нужен контрольный набор запросов и целевые шаблоны ответов для проверки структуры.
  - При отсутствии projectId или нарушении ACL — отказ с понятным сообщением.

## 2. OCR и штампы (PDF)
Описание: распознаёт текст и штампы в PDF сканах/изображениях, выдаёт координаты и confidence, штамп — только из PDF.
- Требования:
  - OCR предобработка (deskew/denoise/binarize); CER/WER печатный текст ≤ 5–10%.
  - Извлечение штампа (title/cipher/sheetNumber/documentName/sheetFormat/designStage/organization/documentDate/revisionNumber) с координатами/confidence.
  - Время OCR ≤ 30 сек/страница; детект типа PDF (mc/scan/mixed) ≤ 3 сек/док.
- Комментарии:
  - Требуются контрольные сканы/изображения для замера точности и времени.
  - DWG не берём для штампа; при необходимости конвертируем в DXF только для таблиц/текста.

## 3. Таблицы (PDF/DXF)
Описание: находит табличные области, восстанавливает структуру (merged, иерархия), извлекает ценовые поля.
- Требования:
  - Полнота извлечения таблиц ≥ 95% по контрольным примерам.
  - Заполненность ценовых полей (price/amount/currency/source/date) ≥ 90%.
  - Структура таблиц (merged/иерархия/итоговые строки) сохраняется; артефакт tables.json/CSV.
- Комментарии:
  - Нужны контрольные PDF/DXF с эталонной разметкой для валидации полноты/структуры.
  - Большие DXF со множеством слоёв могут замедлять обработку; требуется проверка на реальных примерах.

## 4. Сметы (ARP/GSFX/XML/XLSX)
Описание: конвертирует сметы в единую модель Estimate (разделы → позиции → ресурсы), валидирует поля и поддерживает round-trip.
- Требования:
  - Полнота ключевых полей ≥ 95%: разделы (код/наименование), позиции (наименование/единица/количество/цена/сумма), ресурсы.
  - Валидация qty > 0, unitPrice ≥ 0, amount = qty × unitPrice; сохранение projectId/rdCipher.
  - Корректность round-trip (импорт/экспорт) для ARP/GSFX/XML/XLSX; артефакт estimate.json/CSV.
- Комментарии:
  - Требуются контрольные файлы смет и подтверждение версий ARP/GSFX.
  - Время обработки больших смет и ограничения по размеру файлов нужно согласовать.

## 5. Нормативка (ГОСТ/СП)
Описание: загружает локальные нормы, формирует базу знаний и проверяет данные/отчёты на соответствие.
- Требования:
  - Покрытие приоритетных норм ≥ 90% (список уточняется с заказчиком).
  - Отчёты о несоответствиях содержат точные ссылки (норматив/пункт/страница/редакция/дата).
  - Время проверки нормативных требований — в рамках общего SLA ответов (≤ 30 сек для отчёта).
- Комментарии:
  - Нужен список приоритетных ГОСТ/СП и частота обновлений.
  - Требуется согласовать формат хранения базы норм и отчётов.

## 6. Отчёты и экспорт
Описание: генерирует Excel/JSON/CSV отчёты с trace на источники и валидацией структуры/форматирования.
- Требования:
  - Время генерации/экспорта отчёта ≤ 30 секунд.
  - Валидация структуры/форматирования отчётов проходит без критических ошибок.
  - В отчётах есть trace на исходные артефакты и источники цен/нормативов.
- Комментарии:
  - Нужны эталоны шаблонов Excel (ПТО/сметы) для проверки форматирования и печати.
  - Требуется подтвердить лимиты по размеру файлов/числу листов.

## 7. ACL и проектный контекст
Описание: все операции выполняются в проектном контексте; доступы ограничены ролями.
- Требования:
  - 100% артефактов содержат projectId/rdCipher.
  - ACL применён для Учителя/Пользователя/Администратора; при нарушении — отказ и лог.
  - Настройка проектных прав и выдача разовых привилегий фиксируются в журнале.
- Комментарии:
  - Нужен перечень ролей и прав для финальной конфигурации.
  - Требуется согласовать срок хранения журналов ACL.

## 8. Логирование и аудит
Описание: фиксирует шаги обработки, ошибки, действия пользователей; хранит артефакты в предсказуемой структуре.
- Требования:
  - Логи обработки и аудита ведутся по всем операциям (кто/что/когда/статус/детали).
  - Артефакты проверок (validationReport, routeDecision, titleBlock, tables, estimate) сохраняются и версионируются.
  - Доступ к логам ограничен ролями; попытки изменения/удаления фиксируются.
- Комментарии:
  - Согласовать срок хранения логов/артефактов и объём хранилища.
  - Нужен регламент на экспорт/очистку/резервное копирование логов и артефактов.

## 9. Пользовательские сценарии (потоки)
- Учитель системы:
  - Загружает проверенные документы (PDF/сметы), запускает обработку, проверяет артефакты (штамп, таблицы, сметы), вносит правки при необходимости.
  - Запускает формирование отчётов (Excel/CSV/JSON) и проверяет предупреждения/несоответствия.
- Пользователь системы:
  - Формулирует текстовый запрос с проектом, получает структурированный ответ с trace на источники.
  - Запускает готовые отчёты (спецификация, бюджет, сравнение проектов) и анализирует результаты.
- Администратор:
  - Управляет ролями/ACL, конфигурирует пути и модели, следит за логами и инцидентами.
  - Контролирует обновления нормативной базы, моделей, шаблонов отчётов.

## 10. Критерии готовности демо/прототипа
- Обработан согласованный контрольный набор документов (сканы PDF, таблицы, сметы, нормативные примеры).
- Достигнуты целевые метрики (OCR, штампы, таблицы, сметы, нормативка, экспорт) на контрольном наборе.
- Отчёты в Excel/JSON/CSV формируются в пределах SLA и проходят валидацию структуры/форматирования.
- ACL/аудит включены; логи и артефакты сохраняются в ожидаемой структуре.

## 11. Открытые вопросы
- Нужен утверждённый набор контрольных данных (сканы, сметы ARP/GSFX/XML, DXF примеры) и шаблоны Excel для ПТО/смет.
- Требуется список приоритетных ГОСТ/СП и частота обновлений нормативки.
- Согласовать ограничения по размеру файлов, числу страниц/листов и системным ресурсам (CPU/GPU/RAM/диск).
