# Функциональные требования, сценарии и метрики приёмки

**Версия**: 0.1 (черновик для заказчика)  
**Дата**: 2025-XX-XX  
**Назначение**: Самодостаточное описание функций прототипа, пользовательских сценариев и метрик приёмки без ссылок на другие папки.

---

## 1. Запросы и ответы
Описание: система принимает текстовые запросы на русском, учитывает проектный контекст и формирует структурированные ответы (Excel/JSON/CSV) с указанием источников.
- Требования:
  - Принимает запросы с projectId и фильтрами; поддерживает list/detail/aggregate.
  - Формирует ответы с items/aggregates и trace на исходные документы.
  - Время ответа ≤ 30 секунд.
- Комментарии:
  - Нужен контрольный набор запросов и целевые шаблоны ответов для проверки структуры.
  - При отсутствии projectId или нарушении ACL — отказ с понятным сообщением.

## 2. OCR и штампы (PDF)
Описание: распознаёт текст и штампы в PDF сканах/изображениях, выдаёт координаты и confidence, штамп — только из PDF.
- Требования:
  - OCR предобработка (deskew/denoise/binarize); CER/WER печатный текст ≤ 5–10%.
  - Извлечение штампа (title/cipher/sheetNumber/documentName/sheetFormat/designStage/organization/documentDate/revisionNumber) с координатами/confidence.
  - Время OCR ≤ 30 сек/страница; детект типа PDF (mc/scan/mixed) ≤ 3 сек/док.
- Комментарии:
  - Требуются контрольные сканы/изображения для замера точности и времени.
  - DWG не берём для штампа; при необходимости конвертируем в DXF только для таблиц/текста.

## 3. Таблицы (PDF/DXF)
Описание: находит табличные области, восстанавливает структуру (merged, иерархия), извлекает ценовые поля.
- Требования:
  - Полнота извлечения таблиц ≥ 95% по контрольным примерам.
  - Заполненность ценовых полей (price/amount/currency/source/date) ≥ 90%.
  - Структура таблиц (merged/иерархия/итоговые строки) сохраняется; артефакт tables.json/CSV.
- Комментарии:
  - Нужны контрольные PDF/DXF с эталонной разметкой для валидации полноты/структуры.
  - Большие DXF со множеством слоёв могут замедлять обработку; требуется проверка на реальных примерах.

## 4. Обучение и база знаний
Описание: система учится на проверенных документах, хранит знания по проектам и поддерживает экспорт/импорт контекстов.
- Требования:
  - Учитель загружает только валидированные документы; результаты обучения привязаны к projectId.
  - Контекст обучения хранится по проектам; поддержан экспорт/импорт пакетов знаний.
  - Версионирование знаний и возможность rollback; фиксация источников и правок.
- Комментарии:
  - Нужны образцы обучающих наборов (штампы, таблицы, сметы) и правила отбора «проверенных» документов.
  - Требуется согласовать политику хранения версий и права на экспорт/импорт.

## 5. Поиск аналогов по проектам
Описание: поиск похожих проектов по типу/стадии/материалам с выдачей артефактов и метаданных.
- Требования:
  - Индексирует проекты по признакам (тип объекта, стадия, материалы, теги).
  - Выдаёт аналоги с признаками сходства и trace на исходные артефакты.
  - Время ответа ≤ 30 секунд; учитывает ACL и проектный контекст.
- Комментарии:
  - Нужен согласованный перечень признаков сходства и контрольный набор проектов.
  - Требуется формат отчёта по аналогам (поля, сортировка, trace).

## 6. Реестр и валидация шаблонов Excel
Описание: управление шаблонами отчётов (версии, владельцы, области применения) и их валидация (структура, формулы, печать).
- Требования:
  - Хранить шаблоны с версиями и статусами; вести аудит изменений.
  - Проверять отчёты на соответствие активному шаблону (листы, названия, стили, печать, формулы).
  - Генерировать отчёт валидации (validationReport) с ошибками/предупреждениями.
- Комментарии:
  - Нужны эталоны шаблонов ПТО/сметы и правила критичности.
  - Согласовать срок жизни версий и процесс обновления/отката.

## 7. Сметы (ARP/GSFX/XML/XLSX)
Описание: конвертирует сметы в единую модель Estimate (разделы → позиции → ресурсы), валидирует поля и поддерживает round-trip.
- Требования:
  - Полнота ключевых полей ≥ 95%: разделы (код/наименование), позиции (наименование/единица/количество/цена/сумма), ресурсы.
  - Валидация qty > 0, unitPrice ≥ 0, amount = qty × unitPrice; сохранение projectId/rdCipher.
  - Корректность round-trip (импорт/экспорт) для ARP/GSFX/XML/XLSX; артефакт estimate.json/CSV.
- Комментарии:
  - Требуются контрольные файлы смет и подтверждение версий ARP/GSFX.
  - Время обработки больших смет и ограничения по размеру файлов нужно согласовать.

## 7. Нормативка (ГОСТ/СП)
Описание: загружает локальные нормы, формирует базу знаний и проверяет данные/отчёты на соответствие.
- Требования:
  - Покрытие приоритетных норм ≥ 90% (список уточняется с заказчиком).
  - Отчёты о несоответствиях содержат точные ссылки (норматив/пункт/страница/редакция/дата).
  - Время проверки нормативных требований — в рамках общего SLA ответов (≤ 30 сек для отчёта).
- Комментарии:
  - Нужен список приоритетных ГОСТ/СП и частота обновлений.
  - Требуется согласовать формат хранения базы норм и отчётов.

## 8. Отчёты и экспорт
Описание: генерирует Excel/JSON/CSV отчёты с trace на источники и валидацией структуры/форматирования.
- Требования:
  - Время генерации/экспорта отчёта ≤ 30 секунд.
  - Валидация структуры/форматирования отчётов проходит без критических ошибок.
  - В отчётах есть trace на исходные артефакты и источники цен/нормативов.
- Комментарии:
  - Нужны эталоны шаблонов Excel (ПТО/сметы) для проверки форматирования и печати.
  - Требуется подтвердить лимиты по размеру файлов/числу листов.

## 9. ACL и проектный контекст
Описание: все операции выполняются в проектном контексте; доступы ограничены ролями.
- Требования:
  - 100% артефактов содержат projectId/rdCipher.
  - ACL применён для Учителя/Пользователя/Администратора; при нарушении — отказ и лог.
  - Настройка проектных прав и выдача разовых привилегий фиксируются в журнале.
- Комментарии:
  - Нужен перечень ролей и прав для финальной конфигурации.
  - Требуется согласовать срок хранения журналов ACL.

## 10. Управление доступом и права администратора
Описание: Администратор управляет ролями и точечными привилегиями, все изменения аудируются.
- Требования:
  - Назначение/отзыв ролей и привилегий с фиксацией автора, причины, срока действия.
  - Approval на запуск обучения/загрузок при необходимости.
  - Журнал изменений прав хранится и доступен для аудита.
- Комментарии:
  - Согласовать процесс утверждения прав и сроки хранения журнала изменений.
  - Определить, кто имеет право выдавать точечные привилегии по проектам.

## 11. Версионирование данных, контекста и артефактов
Описание: результаты обучения, артефакты и метаданные версионируются с возможностью rollback.
- Требования:
  - Версии для артефактов (штамп/таблицы/сметы), логов и контекста обучения.
  - Возможность сравнения версий и восстановления предыдущей.
  - Структура каталогов артефактов предсказуема; трассировка projectId/requestId/time.
- Комментарии:
  - Согласовать глубину истории и место хранения версий.
  - Определить регламент очистки/архивации старых версий.

## 12. API для внешних систем
Описание: двусторонний REST API для получения знаний и обратной связи.
- Требования:
  - Аутентификация токенами, границы доступа по проектам.
  - Методы получения пакетов знаний и публикации обратных комментариев/актуализаций.
  - Webhook-уведомления об обновлениях с повторной доставкой при сбое.
- Комментарии:
  - Требуется согласовать список внешних систем и форматы обмена.
  - Нужен регламент ротации токенов и SLA по вебхукам.

## 13. Нормативные отчёты и хранение правил
Описание: формирует выжимки нормативов, структурированные правила и отчёты о несоответствиях.
- Требования:
  - Извлекать метаданные DOCX, формировать выжимки и экспорт в PDF с точными ссылками.
  - Хранить правила с условиями/диапазонами/ссылками на пункты; версии правил и нормативов.
  - Генерировать отчёты о несоответствиях с классификацией (Critical/Warning/Info).
- Комментарии:
  - Нужен список приоритетных нормативов и формат правил/выжимок.
  - Согласовать политику обновлений нормативной базы и хранения версий.

## 14. Проектные шаблоны и индекс контекста
Описание: поддержка проектных шаблонов/контекстов, подписки и перенос знаний между проектами.
- Требования:
  - Хранить проектные шаблоны/контексты и подписки на обновления.
  - Экспорт/импорт контекста между проектами с миграцией зависимостей.
  - Индексация контекста для ускоренного поиска и применения шаблонов.
- Комментарии:
  - Требуется согласовать формат пакетов контекста и правила подписки.
  - Нужны примеры проектных шаблонов для проверки процесса миграции.

## 15. Логирование и аудит
Описание: фиксирует шаги обработки, ошибки, действия пользователей; хранит артефакты в предсказуемой структуре.
- Требования:
  - Логи обработки и аудита ведутся по всем операциям (кто/что/когда/статус/детали).
  - Артефакты проверок (validationReport, routeDecision, titleBlock, tables, estimate) сохраняются и версионируются.
  - Доступ к логам ограничен ролями; попытки изменения/удаления фиксируются.
- Комментарии:
  - Согласовать срок хранения логов/артефактов и объём хранилища.
  - Нужен регламент на экспорт/очистку/резервное копирование логов и артефактов.

## 16. Пользовательские сценарии (потоки)
- Учитель системы:
  - Загружает проверенные документы (PDF/сметы), запускает обработку, проверяет артефакты (штамп, таблицы, сметы), вносит правки при необходимости.
  - Запускает формирование отчётов (Excel/CSV/JSON) и проверяет предупреждения/несоответствия.
- Пользователь системы:
  - Формулирует текстовый запрос с проектом, получает структурированный ответ с trace на источники.
  - Запускает готовые отчёты (спецификация, бюджет, сравнение проектов) и анализирует результаты.
- Администратор:
  - Управляет ролями/ACL, конфигурирует пути и модели, следит за логами и инцидентами.
  - Контролирует обновления нормативной базы, моделей, шаблонов отчётов.

## 17. Критерии готовности демо/прототипа
- Обработан согласованный контрольный набор документов (сканы PDF, таблицы, сметы, нормативные примеры).
- Достигнуты целевые метрики (OCR, штампы, таблицы, сметы, нормативка, экспорт) на контрольном наборе.
- Отчёты в Excel/JSON/CSV формируются в пределах SLA и проходят валидацию структуры/форматирования.
- ACL/аудит включены; логи и артефакты сохраняются в ожидаемой структуре.

## 18. Открытые вопросы
- Нужен утверждённый набор контрольных данных (сканы, сметы ARP/GSFX/XML, DXF примеры) и шаблоны Excel для ПТО/смет.
- Требуется список приоритетных ГОСТ/СП и частота обновлений нормативки.
- Согласовать ограничения по размеру файлов, числу страниц/листов и системным ресурсам (CPU/GPU/RAM/диск).
