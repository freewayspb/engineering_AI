# Описание работы прототипа AI GOST

**Версия**: 0.2 (черновик для заказчика)  
**Дата**: 2025-XX-XX  
**Назначение**: Описание прототипа (архитектура, пайплайны, артефакты, метрики).

---

## 0. Словарь терминов (кратко)
- **Учитель системы**: загружает проверенные документы, запускает обработку/обучение, подтверждает результаты.
- **Пользователь системы**: задаёт текстовые запросы, получает структурированные ответы/отчёты.
- **Администратор**: управляет правами, конфигурацией, логами, обновлениями.
- **Проектный контекст**: обязательные projectId/rdCipher для данных и операций; ACL ограничивает доступ.
- **Артефакт**: файл результата/проверки (text.json, tables.json, titleBlock.json, estimate.json/CSV, validationReport.json, routeDecision.json, итоговые Excel/CSV/JSON, логи).
- **ACL**: правила доступа по ролям и проектам.
- **SLA**: целевые сроки выполнения операций (OCR, ответы, экспорт, проверки).
- **OCR/CER/WER**: распознавание текста и метрики точности (символы/слова).
- **Estimate**: унифицированная модель сметы (разделы → позиции → ресурсы).
- **ГОСТ/СП**: локальная нормативная база для проверок и отчётов.
- **Round-trip**: импорт исходного формата → нормализованная модель → экспорт обратно без потерь структуры/формул.

## 1. Обзор и назначение
- **Цель**: подтвердить, что локальная система ИИ может обрабатывать инженерные документы и отвечать на текстовые запросы без доступа к интернету.
- **Объем**: обработка PDF, ARP/GSFX/XML (сметы), RTF/DOCX, XLSX/CSV, изображений (JPG/PNG/TIFF/BMP); DWG при необходимости переводится в DXF для извлечения таблиц/текста (штамп только из PDF). Проектная привязка данных и формирование Excel/JSON/CSV отчётов.
- **Роли**: Учитель системы (загрузка/валидация), Пользователь (запросы/отчёты), Администратор (доступы/конфигурация).

## 2. Термины и роли (кратко)
- **Учитель**: загружает проверенные документы, запускает обработку/обучение, подтверждает результаты.
- **Пользователь**: задаёт текстовые запросы, получает структурированные ответы/отчёты.
- **Администратор**: управляет правами, конфигурацией, логами, обновлениями.
- **Проектный контекст**: все артефакты содержат projectId/rdCipher; операции ограничены ACL.
- **Артефакты**: text.json, tables.json, titleBlock.json, estimate.json/CSV, validationReport.json, routeDecision.json, итоговые Excel/CSV/JSON, логи обработки и аудита.

## 3. Архитектура и стеки
- **Компоненты**: клиент (web/desktop), backend API (Python), локальные модели Ollama для QA/классификации/извлечения, сервисы обработки файлов (PDF/RTF/XLSX/ARP/GSFX/XML, изображения), подсистема логов/артефактов.
- **Принципы**: микросервисность, контейнеризация (Docker/Compose), API-first, offline-first (air-gapped), безопасность by design.
- **Форматы и источники**: PDF (machine-readable/scan/mixed), ARP/GSFX/XML (сметы), RTF/DOCX, XLSX/CSV, изображения. DWG → DXF при необходимости (штамп не извлекается из DXF).
- **Примеры данных**: входные кейсы и артефакты хранятся в `documentation/06-assets/input-documents` и `output-documents`.

## 4. Прототипы (минимальные, изолированные задачи)
- OCR/штамп (PDF):
  - Гипотеза: локальный OCR + детект штампа дают приемлемую точность на сканах заказчика без интернет-доступа.
  - Вход: mc/scan/mixed PDF; контрольный набор с эталонными штампами.
  - Метрики: CER/WER ≤ 5–10%; полнота штампа ≥ 97% по полям; время OCR ≤ 30 сек/стр.
  - Результаты/артефакты: `routeDecision.json`, `titleBlock.json`, `text.json`, логи шагов; примеры исправлений/ручной проверки.
  - Статус: контролировать на согласованном наборе; уточнить DPI/пороги confidence.
- Таблицы (PDF/DXF):
  - Гипотеза: табличные области и ценовые поля извлекаются с сохранением структуры на PDF/DXF чертежах.
  - Вход: PDF таблицы, DXF с нужными слоями; эталонные разметки.
  - Метрики: полнота извлечения ≥ 95%; ценовые поля ≥ 90%; время в SLA; корректность merged/иерархии/итогов.
  - Результаты/артефакты: `tables.json`/CSV, логи, примеры Excel; статусы валидации.
  - Статус: проверить на больших DXF; согласовать лимиты по слоям/размеру.
- Сметы (ARP/GSFX/XML/XLSX):
  - Гипотеза: конвертация в единую модель Estimate с round-trip без потери ключевых полей/формул.
  - Вход: сметы ARP/GSFX/XML/XLSX с известными итогами.
  - Метрики: полнота ключевых полей ≥ 95%; валидация qty/unitPrice/amount; корректность round-trip; SLA по размерам.
  - Результаты/артефакты: `estimate.json`/CSV, статусы формул (OK/Warning/Broken), отчёты об отклонениях, экспорт обратно.
  - Статус: подтвердить поддерживаемые версии ARP/GSFX и требования к округлениям/налогам.
- Нормативка и выжимки:
  - Гипотеза: локальная база ГОСТ/СП с версионированием правил позволяет формировать отчёты о несоответствиях.
  - Вход: приоритетные ГОСТ/СП в PDF/DOCX; контрольный набор правил/кейсов.
  - Метрики: покрытие приоритетных норм ≥ 90%; отчёт ≤ 30 сек; точные ссылки (норматив/пункт/редакция/дата).
  - Результаты/артефакты: выжимки/правила, отчёты о несоответствиях (PDF/JSON), логи проверок.
  - Статус: требуется список приоритетных нормативов и частота обновлений.
- RAG-ответы/trace:
  - Гипотеза: локальные LLM + векторные индексы по проектам дают релевантные ответы с trace.
  - Вход: проектные документы (PDF/XLSX/JSON), индексы по projectId/ACL.
  - Метрики: время ответа ≤ 30 сек; релевантность по согласованному чек-листу; обязательные ссылки на фрагменты; отказ при нарушении ACL.
  - Результаты/артефакты: ответы (Excel/JSON/CSV) с trace, логи поиска/генерации, контрольные запросы.
  - Статус: согласовать контрольные запросы и размер/политику индексов.

## 5. Основные пайплайны и артефакты
- **Детект формата PDF**: классификация mc_pdf/scan_pdf/mixed_pdf → выбор пути; артефакт `routeDecision.json`.
- **OCR (сканы/изображения)**: предобработка (deskew/denoise/binarize), распознавание текста, координаты; артефакт `text.json`.
- **Штампы (PDF)**: детект области штампа, распознавание полей (title/cipher/sheetNumber/documentName/sheetFormat/designStage/organization/documentDate/revisionNumber), координаты и confidence; артефакт `titleBlock.json`.
- **Таблицы**: поиск табличных областей, восстановление структуры (merged, иерархия заголовков), извлечение ценовых полей; артефакт `tables.json`/CSV.
- **Сметы (ARP/GSFX/XML/XLSX)**: унифицированная модель Estimate (разделы → позиции → ресурсы), валидация qty/unitPrice/amount, round-trip; артефакт `estimate.json`/CSV.
- **Нормативка (ГОСТ/СП)**: загрузка локальных норм, формирование базы знаний, проверки и отчёты о несоответствиях.
- **Ответы на запросы**: понимание запроса (NLU), поиск в базе знаний/артефактах, формирование ответов и отчётов (Excel/JSON/CSV).
- **Логи**: processing/audit, validationReport.json (проверки форматов/структуры), артефакты экспортов.

## 6. SLA и метрики
- OCR сканов ≤ 30 сек/страница; детект типа PDF ≤ 3 сек/док.
- Ответ на запрос/генерация Excel/экспорт ≤ 30 сек (зависит от операции).
- Точность: CER/WER печатный текст ≤ 5–10%; штампы ≥ 97%; таблицы полнота ≥ 95%, ценовые поля ≥ 90%; сметы поля ≥ 95%; покрытие приоритетных ГОСТ ≥ 90%.
- Проектная привязка: 100% артефактов с projectId/rdCipher и ACL.

### 6.1 Метрики и acceptance per-пайплайн (контрольные наборы уточняются)
- OCR: CER/WER, время на страницу, наличие координат, лог времени шагов.
- Штампы (PDF): полнота полей, точность координат/confidence, валидация форматов; `titleBlock.json`.
- Таблицы (PDF/DXF): полнота извлечения, заполненность ценовых полей, корректность структуры; `tables.json`/CSV.
- Сметы: полнота ключевых полей, валидация qty/unitPrice/amount, корректность round-trip; `estimate.json`/CSV.
- Нормативка: покрытие приоритетных норм, корректность ссылок в отчётах, время проверки.
- Экспорт/отчёты: время генерации/экспорта, валидация структуры/форматирования, наличие trace/артефактов.
- Проектный контекст/ACL: 100% артефактов с projectId/rdCipher; отказ при нарушении ACL логируется.

Примечание: контрольные наборы и точные пороги согласуются после получения эталонов данных и шаблонов.

## 7. Деплой и окружение
- Docker/Compose, сервисы для backend, клиента и моделей.
- Конфиги через ENV/файлы: пути к данным, модели, хранилища артефактов, порты.
- Локальное развертывание (air-gapped); поддержка кешей моделей/образов.

## 8. Ограничения и риски
- Качество входных данных (низкое качество сканов, сложные чертежи).
- Зависимость от локальных моделей (качество LLM/OCR в offline).
- Нужны эталоны шаблонов Excel ПТО/сметы и список приоритетных ГОСТ/СП.
- Нормативная база требует актуализации; процедуры миграции должны быть отлажены.
- Производительность на целевом железе (CPU/GPU/RAM) требует подтверждения.
- Форматы: DWG не обрабатывается напрямую — при необходимости конвертация в DXF (штамп извлекается только из PDF); ограничения по размеру файлов требуют согласования; версии ARP/GSFX для контрольных наборов пока не подтверждены.
- Скан-качество: шум/кривизна снижают точность; нужна предобработка.
- DXF: большое число слоёв/текста может замедлять обработку; нужна проверка на реальных примерах.

## 9. Открытые вопросы
- Подтвердить фактические SLA на целевом стенде (OCR/запросы/экспорт).
- Предоставить список приоритетных ГОСТ/СП и эталоны Excel-шаблонов подразделений.
- Уточнить версии и объёмы входных смет (ARP/GSFX/XML) и DXF кейсов.
- Подтвердить требования к инфраструктуре (CPU/GPU, RAM, диск) и список моделей для прод-стенда.
